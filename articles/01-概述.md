leveldb 是一个非常经典的基于 LSM 树(Log Structured-Merge Tree)实现的 KV 数据库。LSM 的核心思想是使用顺序写代替随机写，牺牲部分读取能力换取写入能力。

## 组件

我们在 leveldb 中需要注意几个重要组件：

- Memtable
- Immutable Memtable
- Log (Write Ahead Logging)
- SSTable
- Manifest
- Current

![](img001.png)

MemTable 是一个内存中的有序 map 结构，它的底层实现是一个跳表。在进行写入时，总是首先会写入 MemTable，当 Memtable 的大小达到阈值(4MB)时，MemTable 会被转变为不可写入的 Immutable Memtable。随后 leveldb 的后台线程会将 Immutable Memtable 的内容转换为 SSTable 格式持久化到磁盘上。

SSTable (Sorted String Table) 是负责将键值对持久化存储在磁盘上的结构，键值对在table 文件中按照字典序有序排列，故而命名为 Sorted String。此外，SSTable 中也包含了一些索引数据以便于查询。SSTable 一旦创建便不可修改，不可变的设计极大地简化实现并行操作的复杂度。

leveldb 在修改或删除数据时会直接在 MemTable 中写入新版本的数据，并等待 MemTable 落盘形成新的 SSTable。如果不进行优化，在读取时必须先搜索 MemTable 然后从新到旧搜索每一个 SSTable 才能确定某个 key 存储在哪个 table 文件中，这必然会花费大量时间。

另外, 这种写入可能导致多个 SSTable 中包含同一个 Key 的不同版本，而其中比较陈旧的版本不会被读取到，只是在白白浪费磁盘空间。

为了解决这些问题，leveldb 将 sstable 分成多层（level）进行管理。Immutable Memtable 持久化产生的文件存储在 level0。当 level 0 中的文件过多时，leveldb 便会将多个 table 合并为一个 table 放入 level1，当 level1 中数据过多时便会被合并放入 level2。这个合并操作被称为 Merge 或 Compaction, 它是 leveldb 的核心逻辑之一，我们将会在后面详细进行分析。

除了 level0 之外其它层中的 sstable 是有序排列且不重叠的，在读取时可以迅速判断是否要进入 SSTable 进行搜索。

![](img002.png)

如上图所示，Level0 Table1 中 key 的范围是 "ace" 到 "dog", Level0 Table2 中 key 的范围是 "boy" 到 "edge", 如果我们在 level0 中搜索 "cat" 首先要搜索 Table1, 如果 Table1 中没有找到则需要再搜索 Table2。也就是说我们需要搜索每一个 key range 中包含 "cat" 的 table。

如果我们在 Level1 中搜索 "cat" 只需要搜索 Table2, 因为 Level1 中 table 的 key range 不重叠，所以其它 table 的 key range 中不可能包含 "cat"。

为什么 Level0 中 sstable 不能避免重叠呢？因为避免重叠需要将有重叠部分的 table 读入、合并后重新存盘，这显然是非常耗时的操作。但是由于内存有限我们必须尽快将 Memtable 存盘腾出空间来给新的 Memtable(实际上 Memtable 持久化会阻塞写入操作)，所以 level0 采用了最快速的方法：不进行 merge 操作直接持久化 Memtable。

MANIFEST 文件就是用来管理 leveldb 中的 sstable 的，它记录了每层有哪些 sstable、每个 sstable 的 key range 等信息。

我们刚刚提到 leveldb 会将 sstable 进行合并，每次合并都会产生一个新的 MANIFEST 文件，而 CURRENT 文件只记录一个信息，就是最新的 MANIFEST 文件名，便于 leveldb 重启时正确加载数据。

上文中提到 leveldb 的写操作并不是直接写入磁盘的，而是首先写入到内存中的 MemTable 。假设写入到内存的数据还未来得及持久化，leveldb 崩溃抑或是宿主机器发生了宕机则会造成用户的写入发生丢失。因此 leveldb 在写内存之前会首先将所有的写操作写到 log 文件(这种 log 通常被称为 Write Ahead Logging, WAL)中，在出现异常后根据 log 文件进行恢复。

> 在我们后续的文章和 leveldb 的注释中，log 通常特指 WAL 而不是通常的用于 debug 的文本日志。

> leveldb 自带的注释中 File 通常特指 SSTable